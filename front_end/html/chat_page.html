<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cuea Assistant Bot</title>

    <!-- Link Css-->
    <link rel="stylesheet" href="/front_end/root.css">

    <!-- Google Fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap"
          rel="stylesheet">

    <!-- Box Icon-->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
<header>
    <a href="/home" class="logo">
        <i class="bx bxs-bot"></i>
        <span>Cuea Assistant Bot</span>
    </a>


    <ul class="navbar">
        <li><a href="/home">Home</a></li>
        <li><a href="/chat" class="active">Chat Page</a></li>
    </ul>

    <div class="profile">
        <a href="/profile" class="user"><i class="bx bxs-user"></i>Profile</a>
        <div class="bx bx-menu" id="menu-icon"></div>
    </div>
</header>

<div class="chatbox-wrapper">
    <div class="chatbox-message-wrapper">
        <div class="chatbox-message-content">

            <div class="no-message">
                <span class="no-message-text">
                    Start a conversation
                </span>
            </div>

            <!--            <div class="chatbox-message-date">-->
            <!--                <span class="chatbox-message-current-date"></span>-->
            <!--            </div>-->

            <!--            &lt;!&ndash; Bot's response &ndash;&gt;-->
            <!--            <div class="chatbox-message-item received">-->
            <!--                <span class="chatbox-message-item-text"></span>-->
            <!--                <span class="chatbox-message-item-time"></span>-->
            <!--            </div>-->

            <!--            &lt;!&ndash; User's input &ndash;&gt;-->
            <!--            <div class="chatbox-message-item sent">-->
            <!--                <span class="chatbox-message-item-text"></span>-->
            <!--                <span class="chatbox-message-item-time"></span>-->
            <!--            </div>-->
        </div>

        <!-- Message input form -->
        <div class="chatbox-message-bottom">
            <form class="chatbox-message-form" id="chatbox_form" method="POST">
                <label for="chat_input" class="chatbox-message-form-label">
                    <textarea rows="1" placeholder="Type message..." class="chat-message-input" id="chat_input"
                              name="user_input">
                    </textarea>
                </label>

                <button type="submit" class="chatbox-message-submit" id="submitInput">
                    <i class="bx bxs-send"></i>
                </button>
            </form>
        </div>

    </div>
</div>

<script>
    const textArea = document.querySelector('.chat-message-input');
    const chatBoxForm = document.querySelector('.chatbox-message-form');


    textArea.addEventListener('input', function () {
        let line = textArea.value.split("\n").length;

        if (textArea.rows < 6 || line < 6) {
            textArea.rows = line;
        }

        if (textArea.row > 1) {
            chatBoxForm.style.alignItems = 'flex-end';
        } else {
            chatBoxForm.style.alignItems = 'center';
        }
    });

    const chatBoxMessageWrapper = document.querySelector('.chatbox-message-content');
    const chatBoxNoMessage = document.querySelector('.no-message');

    chatBoxForm.addEventListener('submit', function (event) {
        event.preventDefault();

        if (isValid(textArea.value)) {
            getUserInput();
        }

    });

    textArea.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            chatBoxForm.dispatchEvent(new Event('submit'));
        }
    });


    function getTime() {
        let date = new Date();
        let hours = date.getHours();
        let minutes = date.getMinutes();
        let ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        // the hour '0' should be '12''
        hours = hours ? hours : 12;
        minutes = minutes < 10 ? '0' + minutes : minutes;

        return hours + ':' + minutes + ' ' + ampm;
    }

    //test double data
    function getBotResponse(input) {
        // Make HTTP request to the server to get the response
        const request = new XMLHttpRequest();
        request.open('POST', '/chat');
        request.setRequestHeader('Content-Type', 'application/json');
        request.onload = function () {
            if (request.status === 200) {
                const response = JSON.parse(request.responseText);
                const botResponse = response.bot_response;

                let message = `
                <div class="chatbox-message-item received">
                    <span class="chatbox-message-item-text">${botResponse}</span>
                    <span class="chatbox-message-item-time">${getTime()}</span>
                </div>
                `;

                chatBoxMessageWrapper.insertAdjacentHTML('beforeend', message);
                scrollToBottom();
                console.log(botResponse);
            } else {
                console.log(`Error ${request.status} ${request.statusText}`);
            }
        };
        const data = JSON.stringify({user_input: input});
        request.send(data);
    }


    let lastDisplayedDate = '';

    function getUserInput() {
        let userText = textArea.value.trim();

        if (isValid(userText)) {
            let message = `
        <div class="chatbox-message-item sent">
            <span class="chatbox-message-item-text">${userText.replace(/\n/g, '<br>\n')}</span>
            <span class="chatbox-message-item-time">${getTime()}</span>
        </div>
        `;

            const currentDate = new Date().toLocaleDateString();
            if (currentDate !== lastDisplayedDate) {
                const date = `
                <div class="chatbox-message-date">
                    <span class="chatbox-message-current-date">${currentDate}</span>
                </div>
                `;
                chatBoxMessageWrapper.insertAdjacentHTML('beforeend', date);
                lastDisplayedDate = currentDate;
            }

            chatBoxMessageWrapper.insertAdjacentHTML('beforeend', message);
            chatBoxForm.style.alignItems = 'center';
            textArea.rows = 1;
            textArea.focus();
            textArea.value = '';
            chatBoxNoMessage.style.display = 'none';
            scrollToBottom();

            getBotResponse(userText);
        }

    }

    function scrollToBottom() {
        chatBoxMessageWrapper.scrollTo(0, chatBoxMessageWrapper.scrollHeight);
    }

    function isValid(value) {
        let text = value.replace(/\n/g, '');
        text = text.replace(/\s/g, '');

        return text.length > 0;
    }


</script>

</body>
</html>
